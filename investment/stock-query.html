<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>CSV 資料讀取與結構建立</title>
</head>
<body>
  <h1>開發者請打開 Console 看資料結構！</h1>

  <script>
    // Google Sheets CSV 連結
    const investorCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRQlSijrrBhnnI9iHyYLdFhiV_ykLNwQhOQ3QSeIAXP6ZCn-1r03oov2AvjL6W_AwvL0QRIYZ-W-3nB/pub?gid=856920333&single=true&output=csv';
    const priceCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRQlSijrrBhnnI9iHyYLdFhiV_ykLNwQhOQ3QSeIAXP6ZCn-1r03oov2AvjL6W_AwvL0QRIYZ-W-3nB/pub?gid=0&single=true&output=csv';

    // 股票價格資料: { 2330: { init: xxx, current: xxx }, ... }
    const priceData = {};

    // 投資人資料: { 豪: [{ percent: 30, stock: "PLTR" }, ...], ... }
    const investorData = {};

    async function fetchCSV(url) {
      const response = await fetch(url);
      const text = await response.text();
      return text.trim().split('\n').map(row => {
        // 支援用逗號分隔但包含引號的格式
        const match = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
        return match ? match.map(v => v.replace(/^"|"$/g, '')) : [];
      });
    }

    async function main() {
      // 下載 CSV
      const rawPrice = await fetchCSV(priceCSV);
      const rawInvestor = await fetchCSV(investorCSV);

      // 1. 解析 price CSV
      for (let i = 1; i < rawPrice.length; i++) {
        const [stock, priceInit, priceCurrent] = rawPrice[i];
        if (!stock || !priceInit || !priceCurrent) continue;
        const symbol = stock.trim().toUpperCase();
        priceData[symbol] = {
          init: parseFloat(priceInit),
          current: parseFloat(priceCurrent)
        };
      }

      // 2. 解析 investor CSV
      for (let i = 1; i < rawInvestor.length; i++) {
        const [name, rawHoldings] = rawInvestor[i];
        if (!name || !rawHoldings) continue;

        const lines = rawHoldings.split('\n');
        investorData[name.trim()] = [];

        for (const line of lines) {
          const match = line.trim().match(/^(\d+)%\s+(.+)$/);
          if (match) {
            const percent = parseFloat(match[1]);
            const stock = match[2].trim().toUpperCase();
            investorData[name.trim()].push({ percent, stock });
          }
        }
      }

      // 3. 印出資料結構
      console.log('📊 價格資料 (priceData):', priceData);
      console.log('👤 投資人資料 (investorData):', investorData);
    }

    main();
  </script>
</body>
</html>
